
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>ahmsec</title>
  <meta name="author" content="Ahmad Khan">

  
  <meta name="description" content="Here is a bug I reported to LastPass, copied below with some edits. They shipped a fix within 4 business days and paid out a $1k bounty. One takeaway &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ahmsec.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="ahmsec" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-80270418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">ahmsec</a></h1>
  
    <h2>Remarks on web security & other topics</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="ahmsec.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/01/12/csrf-in-lastpass-website-client/">CSRF in LastPass Website Client</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-01-12T17:00:00-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>5:00 pm</span></time>
        
           | <a href="/blog/2019/01/12/csrf-in-lastpass-website-client/#disqus_thread"
             data-disqus-identifier="http://ahmsec.github.io/blog/2019/01/12/csrf-in-lastpass-website-client/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here is a bug I reported to LastPass, copied below with some edits. They shipped a fix within 4 business days and paid out a $1k bounty.</p>

<p>One takeaway is the importance of defense-in-depth. While our development standards may prohibit sensitive tokens in URLs, it can still happen due to human error. We can mitigate this by adding a strict <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy">Referrer Policy</a> like <code>&lt;meta name="referrer" content="no-referrer"&gt;</code>.</p>

<p>A second takeaway is the importance of secure defaults. In this scenario the top-level frame actually had an <code>origin</code> Referrer Policy. However, it did not prevent the vulnerability because the browser didn&rsquo;t <a href="https://www.w3.org/TR/referrer-policy/#referrer-policy-delivery-nested">inherit</a> the policy to child iframes. A more secure default may be for browsers to inherit Referrer Policy to child iframes if they&rsquo;re on the same origin and don&rsquo;t specify their own policy.</p>

<h2>LastPass Bug Report</h2>

<h3>Summary</h3>

<p>The website client (<a href="https://lastpass.com">https://lastpass.com</a>) leaks CSRF tokens to saved websites. This happens because the iframe containing &ldquo;Launch&rdquo; buttons has the CSRF token embedded in the <code>src</code> attribute.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;iframe</span> <span class="na">id=</span><span class="s">&quot;newvault&quot;</span> <span class="na">style=</span><span class="s">&quot;border: 0px; width: 100%; height: 100%;&quot;</span> <span class="na">src=</span><span class="s">&quot;newvault/vault.php?noscript=1&amp;amp;fromindex=1&amp;amp;ac=1&amp;amp;lpnorefresh=1&amp;amp;fromwebsite=1&amp;amp;newvault=1&amp;amp;nk=1&amp;amp;xmlerr=1&amp;amp;token=[redacted]&quot;</span><span class="nt">&gt;&lt;/iframe&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This vulnerability affects Firefox and potentially other browsers, but does not appear to affect Chrome (not sure why, could be browser referrer policy inheritance or different app codebases).</p>

<h3>Impact</h3>

<p>A malicious webpage can make various state-changing requests to LastPass, and LastPass will honor them.</p>

<p>Affected endpoints include changing password hint and changing master password (only resulting in account lockout, not credential leak).</p>

<p>There are likely to be more affected endpoints.</p>

<h3>Reproduction steps</h3>

<ol>
<li>Log into the Firefox website client on <a href="https://lastpass.com.">https://lastpass.com.</a></li>
<li>Add a new site and set the URL to <a href="https://www.example.com.">https://www.example.com.</a></li>
<li>Click &lsquo;Launch&rsquo; on the new site.</li>
<li>On the launched page, open your browser dev console and type <code>document.referrer</code>.</li>
<li>Notice the LastPass CSRF token included in the referrer. This is readable by target sites.</li>
</ol>


<p>If anything doesn&rsquo;t work, be sure you set the target to an HTTPS site, used Firefox, and used the website client and not the extension.</p>

<h3>Proof of concept</h3>

<ol>
<li>Use Firefox to log into <a href="https://lastpass.com.">https://lastpass.com.</a></li>
<li>Add a new site and set the URL to <a href="https://poc.ahmsec.io/3302aa361e2a44ca9bb82d66bfedd243/lastpass-csrf.html">https://poc.ahmsec.io/3302aa361e2a44ca9bb82d66bfedd243/lastpass-csrf.html</a>.</li>
<li>Click &lsquo;Launch&rsquo; on the newly added site.</li>
<li>Click &lsquo;Change my password hint&rsquo;. <em>A real exploit would do this step silently without prompt.</em></li>
<li>Check your password hint and notice that it changed to &ldquo;i-got-hacked&rdquo;.</li>
</ol>


<h3>Potential attack scenarios</h3>

<ul>
<li>Victim generates &amp; saves creds for some shady one-off online store. Online store is either compromised or malicious. When victim launches site from LastPass, the site can carry out CSRF attacks against victim&rsquo;s LastPass.</li>
<li>Malicious user shares site with victim on LastPass. Victim launches site to check it out, and is attacked via CSRF.</li>
</ul>


<h3>Suggested mitigations</h3>

<ol>
<li>Send CSRF tokens in request body or header instead of URL parameter.

<ul>
<li>URL parameters have higher risk of leakage via referrers and logs.</li>
</ul>
</li>
<li>Add a <code>&lt;meta name="referrer" content="no-referrer"&gt;</code> referrer policy to <a href="https://lastpass.com/newvault/vault.php.">https://lastpass.com/newvault/vault.php.</a>

<ul>
<li>This policy is included on the parent frame, but not in the vault.php nested iframe.</li>
</ul>
</li>
<li>On highly sensitive endpoints, <em>require</em> password hash in addition to CSRF token.

<ul>
<li>E.g. while password changes do require entering old password, the final POST request can be made without it. (See sample request.)</li>
</ul>
</li>
<li>Restrict CSRF tokens to sessions. Do not let them be reused across sessions.</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/11/22/xss-filter-evasion-via-case-change/">XSS Filter Evasion via Case Change</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-11-22T14:32:00-08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2018</span></span> <span class='time'>2:32 pm</span></time>
        
           | <a href="/blog/2018/11/22/xss-filter-evasion-via-case-change/#disqus_thread"
             data-disqus-identifier="http://ahmsec.github.io/blog/2018/11/22/xss-filter-evasion-via-case-change/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://twitter.com/x00x90_/status/1060397253024727040">This</a> tweet describes an interesting behavior: certain non-ASCII characters map to ASCII characters when converted to upper- or lower-case. Specifically:</p>

<pre><code>ı (\u0131) to upper-case --&gt; I
ſ (\u017f) to upper-case --&gt; S
İ (\u0130) to lower-case --&gt; i
K (\u212a) to lower-case --&gt; k
</code></pre>

<p>This can help bypass XSS filters and blacklists. For example, the filter in the app below can be bypassed by <code>?name=&lt;ſcript src="/alert1.js"&gt;&lt;/script&gt;</code>.</p>

<figure class='code'><figcaption><span>vulnerable-app.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">Response</span>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;guest&#39;</span>
</span><span class='line'>    <span class="k">if</span> <span class="s">&#39;&lt;script&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&#39;XSS DENIED!&#39;</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;&lt;html&gt;Welcome, &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;!&lt;/html&gt;&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/ALERT1.JS&quot;</span><span class="p">)</span> <span class="c">#normally hosted on attacker site</span>
</span><span class='line'><span class="k">def</span> <span class="nf">alert1</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;alert(1)&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As usual, the best practice for XSS prevention is <a href="https://www.owasp.org/index.php/XSS_%28Cross_Site_Scripting%29_Prevention_Cheat_Sheet">character encoding</a>. Blacklists are easily <a href="https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet">bypassed</a>.</p>

<p>Here is a quick script to enumerate characters affected by this behavior. Interestingly, it appears that Python 2 and 3 treat <code>İ (\u0130)</code> differently.</p>

<figure class='code'><figcaption><span>casing-xss.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'>
</span><span class='line'><span class="n">interestingChars</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span><span class="mi">91</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">97</span><span class="p">,</span><span class="mi">123</span><span class="p">)]</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x10FFFF</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span class='line'>    <span class="n">char</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-32&#39;</span><span class="p">,</span> <span class="s">&#39;surrogatepass&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">charLower</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">charLower</span> <span class="ow">in</span> <span class="n">interestingChars</span> <span class="ow">and</span> <span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">interestingChars</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="s">&#39;{} ({}) to lower-case --&gt; {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span> <span class="n">charLower</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">charUpper</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">charUpper</span> <span class="ow">in</span> <span class="n">interestingChars</span> <span class="ow">and</span> <span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">interestingChars</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="s">&#39;{} ({}) to upper-case --&gt; {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span> <span class="n">charUpper</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/08/31/csrf-double-submit-cookies-insufficient-against-mitm/">CSRF: Double Submit Cookies Insufficient Against MitM</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-08-31T08:38:05-07:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2016</span></span> <span class='time'>8:38 am</span></time>
        
           | <a href="/blog/2016/08/31/csrf-double-submit-cookies-insufficient-against-mitm/#disqus_thread"
             data-disqus-identifier="http://ahmsec.github.io/blog/2016/08/31/csrf-double-submit-cookies-insufficient-against-mitm/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Suppose you’re at the latest hip coffee shop in town, enjoying their comfy chairs and high-speed wifi. You’re doing some confidential work using a relatively secure web application. The application always uses TLS, redirects HTTP requests back to HTTPS, and deploys <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_%28CSRF%29_Prevention_Cheat_Sheet#Double_Submit_Cookie">Double Submit Cookies</a> (with the ‘secure’ cookie flag) to protect from CSRF. Now suppose that the coffee shop staff becomes part of your threat model. Could they still launch CSRF attacks against you? After all, they can’t read TLS-encrypted traffic, so they can’t possibly steal CSRF tokens.</p>

<p>It turns out that actually yes, given the scenario above, a man-in-the-middle (with your pick of malicious staff, rogue access point, or ARP poisoning) can defeat the Double Submit defense. And it’s a simple attack, not one that requires you to break TLS or WPA2. Here’s how it works:</p>

<ol>
<li>Victim conducts secret business on <a href="https://secret.example.com">https://secret.example.com</a> (MitM attacker can’t read this traffic.)</li>
<li>Victim visits a non-SSL website like <a href="http://stackoverflow.com">http://stackoverflow.com</a> or <a href="http://www.cnn.com">http://www.cnn.com</a> (MitM can read and modify this traffic.)</li>
<li>MitM injects <code>&lt;img src=”http://secret.example.com/non-existent.png”/&gt;</code> into the response from (2). Note that the img tag’s protocol is HTTP and not HTTPS.</li>
<li>Victim’s browser receives the image tag, and sends a secondary non-SSL request to <a href="http://secret.example.com/non-existent.png.">http://secret.example.com/non-existent.png.</a> (CSRF cookie not sent because of secure flag.)</li>
<li>MitM intercepts the response from <a href="http://secret.example.com,">http://secret.example.com,</a> which could be a 301 redirect [1] or a 404 error, and injects a Set-Cookie header that overwrites the victim’s CSRF cookie with a known value. Details on how later.</li>
<li>Since the attacker knows the CSRF cookie value, he or she can now trigger a request that includes the CSRF token in the body.</li>
</ol>


<p>All of this can be automated for your exploit. A non-intuitive step in this attack scenario is perhaps #5. How could a non-SSL response possibly overwrite cookies that have the ‘secure’ flag and that were set under SSL? That unfortunately is allowed by design and is how the web works today. Here’s an article that describes the issue: <a href="http://scarybeastsecurity.blogspot.com/2008/11/cookie-forcing.html">http://scarybeastsecurity.blogspot.com/2008/11/cookie-forcing.html</a> .</p>

<p>One way to protect against this scenario is to use HSTS. However, you have to make sure that every single subdomain has HSTS, because any child subdomain can be used to set cookies for the top-level parent domain, and those cookies will subsequently be sent with requests to every subdomain. You also have make sure you don’t have users on browsers without <a href="http://caniuse.com/#feat=stricttransportsecurity">HSTS support</a>, such as IE &lt; v11.</p>

<p>A few takeaways:</p>

<ol>
<li>Double Submit Cookies are a common way to protect against CSRF. They’re recommended by OWASP and used by several websites and frameworks. However, if you need to protect against MitM, you should consider a different defense.</li>
<li>Cookies should be treated as untrusted and attacker-controlled input. Be careful of mistakes like allowing user-generated session cookies and not sanitizing cookie-sourced values for XSS.</li>
</ol>


<p>For further discussion on these topics, please see the following articles. <br/>
&nbsp;&nbsp;&nbsp;&nbsp; - <a href="http://scarybeastsecurity.blogspot.com/2008/11/cookie-forcing.html">http://scarybeastsecurity.blogspot.com/2008/11/cookie-forcing.html</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp; - <a href="https://media.blackhat.com/eu-13/briefings/Lundeen/bh-eu-13-deputies-still-confused-lundeen-wp.pdf">https://media.blackhat.com/eu-13/briefings/Lundeen/bh-eu-13-deputies-still-confused-lundeen-wp.pdf</a></p>

<hr />

<p>[1] For a workaround to browsers’ aggressive caching of 301 redirects, see <a href="http://security.stackexchange.com/a/117138.">http://security.stackexchange.com/a/117138.</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/07/05/the-dangers-of-jsonp/">The Dangers of JSONP</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-07-05T16:34:03-05:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>4:34 pm</span></time>
        
           | <a href="/blog/2016/07/05/the-dangers-of-jsonp/#disqus_thread"
             data-disqus-identifier="http://ahmsec.github.io/blog/2016/07/05/the-dangers-of-jsonp/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post is about how I learned of JSONP as an attack vector. This isn&rsquo;t a new vulnerability, but it&rsquo;s just nice that I discovered it on my own.</p>

<h3>A note on Same-Origin Policy</h3>

<p>Same-Origin Policy (SOP) prevents a webpage from reading data on a different domain. So if you open a tab with hacker.com, your browser won&rsquo;t let it read data on bank.com. There are notable exceptions, like <code>&lt;img&gt;</code> and <code>&lt;script&gt;</code> tags. However, browsers strictly limit their scope. For example, a webpage can only execute a cross-domain script, not read its contents.</p>

<h3>Some interesting behavior</h3>

<p>Playing with traffic in Burp I observed the following behavior. Whatever you pass in the &ldquo;callback&rdquo; parameter is reflected in the response.</p>

<p>Request: <code>GET /sensitive_resource?callback=myFunction</code> <br/>
Response: <code>myFunction({"key1":"data1", "key2":"data2", ...})</code></p>

<p>Request: <code>GET /sensitive_resource?callback=AAAAAAAA</code> <br/>
Response: <code>AAAAAAAA({"key1":"data1", "key2":"data2", ...})</code></p>

<p>My first instinct was to test for XSS, but all output was correctly encoded. The response contained private data, but it required an authenticated session to access.</p>

<p>(Later on I learned that this request/response behavior is an old technique called JSONP. It was used to get around Same-Origin Policy restrictions before CORS came about.)</p>

<h3>The exploit</h3>

<p>What if we request that resource from a <code>&lt;script&gt;</code> tag on the attacker&rsquo;s webpage? Notice that the response data is wrapped with a JavaScript function call that we control. Can we pre-define that function on the attacker&rsquo;s webpage?</p>

<p><strong>www.attacker.com:</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script&gt;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">exfil_function</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">parsed_data</span> <span class="o">=</span> <span class="nx">response_specific_parsing</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">alert</span><span class="p">(</span><span class="nx">parsed_data</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">exfil</span><span class="p">(</span><span class="nx">parsed_data</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;https://www.victim.com/sensitive_resource?callback=exfil_function&quot;</span><span class="nt">&gt;</span> <span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And it works! The cross-domain script executes <code>exfil_function({"key1":"data1", "key2":"data2", ...})</code>, and since we control the definition of <code>exfil_function</code>, we can have it read the data!</p>

<p>Now when an authenticated victim views this malicious webpage, it does a cross-domain read of the sensitive resource and exfiltrates the private data.</p>

<h3>Lesson: don&rsquo;t use JSONP with private data</h3>

<p>JSONP effectively disables Same-Origin Policy for a resource. So be cautious of using it with private data. Instead, use CORS, which gives you fine-grained and securely designed control over cross-origin sharing.</p>

<p>A slightly related vulnerability is <a href="http://haacked.com/archive/2009/06/25/json-hijacking.aspx/">JSON Hijacking</a>. In conclusion, do not return sensitive data wrapped in JavaScript functions or arrays.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/07/03/custom-headers-as-csrf-defense/">Custom Headers as CSRF Defense</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-07-03T16:18:01-07:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2016</span></span> <span class='time'>4:18 pm</span></time>
        
           | <a href="/blog/2016/07/03/custom-headers-as-csrf-defense/#disqus_thread"
             data-disqus-identifier="http://ahmsec.github.io/blog/2016/07/03/custom-headers-as-csrf-defense/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>CSRF is a prevalent and well-known vulnerability that affects web applications. The common way to protect against CSRF is to require anti-CSRF tokens on state-modifying requests. For defense in depth, you can add an extra layer of security by additionally requiring custom headers. This can mitigate scenarios where anti-CSRF tokens are somehow leaked (something I have seen happen).</p>

<h3>Simple vs Preflighted Requests</h3>

<p>The Mozilla <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS">article</a> on CORS does a nice job of explaining the difference between &ldquo;simple&rdquo; and &ldquo;preflighted&rdquo; requests.</p>

<ul>
<li><p><strong>Simple requests</strong> are sent by traditional mechanisms on the web, such as GETs made by <code>&lt;img&gt;</code> tags or POSTs made by HTML forms. The browser will always send them cross-origin, and will always pass along session cookies. This behavior is what makes CSRF possible.</p></li>
<li><p><strong>Preflighted requests</strong> are requests that either contain custom headers or use methods other than GET, POST, or HEAD. Browsers will refuse to send these requests cross-origin unless the server explicitly allows it. To check this permission, browsers will send a &ldquo;pre-flight&rdquo; OPTIONS request before sending the actual request, and the server has to reply with the appropriate CORS headers. If the server doesn&rsquo;t, the actual request is never sent.</p></li>
</ul>


<p> Note the difference: simple requests are always sent cross-origin, even though Same-Origin Policy blocks the responses. When preflighted, the request isn&rsquo;t even sent in the first place.</p>

<h3>Preflighted Requests and CSRF</h3>

<p>If a resource requires a non-standard header or method, it won&rsquo;t be sent cross-origin (unless the victim domain for some reason whitelists the attacker domain). Since the request is never sent, CSRF attacks are blocked.</p>

<h3>Bypassing Custom Header Restrictions</h3>

<p>While requiring custom headers is a useful layer of CSRF defense, it shouldn&rsquo;t be the only one. Up until March 2015, Adobe Flash had a vulnerability that allowed you to send custom headers cross-origin. Here are two well-written posts describing the technique:</p>

<ul>
<li> <a href="http://lists.webappsec.org/pipermail/websecurity_lists.webappsec.org/2011-February/007533.html">http://lists.webappsec.org/pipermail/websecurity_lists.webappsec.org/2011-February/007533.html</a></li>
<li> <a href="http://www.appsecweekly.com/flash-same-origin-policy-bypass-with-307/">http://www.appsecweekly.com/flash-same-origin-policy-bypass-with-307/</a></li>
</ul>


<h3>Conclusion</h3>

<p>Consider requiring custom headers on your sensitive state-modifying requests. For example, you can require an X-Requested-With header on AJAX calls and refuse to honor those that don&rsquo;t include it.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/24/first-post/">First Post!</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-06-24T07:15:45-07:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>7:15 am</span></time>
        
           | <a href="/blog/2016/06/24/first-post/#disqus_thread"
             data-disqus-identifier="http://ahmsec.github.io/blog/2016/06/24/first-post/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I know you&rsquo;ve been waiting eagerly, but it&rsquo;s finally here: my own personal blog! &hellip; Just kidding, I can hear the crickets chirping. This is intended to be an informal space for me to write about topics of interest. Mostly technical posts about what I&rsquo;m learning in &ldquo;cyber&rdquo; security (to use the current vernacular). Perhaps other topics as well. If future generations come across these posts and benefit, that will be great!</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/01/12/csrf-in-lastpass-website-client/">CSRF in LastPass Website Client</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/11/22/xss-filter-evasion-via-case-change/">XSS Filter Evasion via Case Change</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/08/31/csrf-double-submit-cookies-insufficient-against-mitm/">CSRF: Double Submit Cookies Insufficient Against MitM</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/05/the-dangers-of-jsonp/">The Dangers of JSONP</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/07/03/custom-headers-as-csrf-defense/">Custom Headers as CSRF Defense</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Ahmad Khan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ahmsec';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
